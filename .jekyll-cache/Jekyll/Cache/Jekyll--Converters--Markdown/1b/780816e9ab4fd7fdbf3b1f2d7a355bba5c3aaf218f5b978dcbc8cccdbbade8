I"Yº<p>ì˜¤ëŠ˜ì€ ìƒˆë¡œ ê°€ì…í•œ kaggle ìŠ¤í„°ë””ì—ì„œ ë°œí‘œì¤€ë¹„ë¥¼ í•˜ë©´ì„œ ê³µë¶€í•œ ë‚´ìš©ì„ ì •ë¦¬í•´ ë³´ì•˜ìŠµë‹ˆë‹¤.</p>

<p>ì£¼ì œëŠ” kaggleì˜ Pawpularity Contestì´ë©°,  ë§í¬ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

<ul>
  <li>kaggleì˜ ì£¼ì œ ì‚¬ì´íŠ¸</li>
</ul>

<ul>
  <li>ë¶„ì„í•  ì½”ë“œ ë§í¬</li>
</ul>

<p>&lt; ëª©ì°¨ &gt;</p>

<h1 id="1-pawpularity-data">1. Pawpularity Data</h1>

<h2 id="sample_submissioncsv">sample_submission.csv</h2>

<p>[id, pawpularity] ë¡œ êµ¬ì„±</p>

<h2 id="testcsv">test.csv</h2>

<p>trainì—ì„œ pawpularityê°€ ì—†ëŠ” ë°ì´í„°ì…ë‹ˆë‹¤.</p>

<p>idê°’ ë¹¼ê³ ëŠ” ì „ë¶€ 0, 1 ì´ì§„ë°ì´í„°ì…ë‹ˆë‹¤.</p>

<table>
  <thead>
    <tr>
      <th>id</th>
      <th>The photos unique Pet Profile ID corresponding to the photoâ€™s file name.</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Subject Focus</td>
      <td>Pet stands out against uncluttered background, not too close / far.</td>
    </tr>
    <tr>
      <td>Eyes</td>
      <td>Both eyes are facing front or near-front, with at least 1 eye / pupil decently clear.</td>
    </tr>
    <tr>
      <td>Face</td>
      <td>Decently clear face, facing front or near-front.</td>
    </tr>
    <tr>
      <td>Near</td>
      <td>Single pet taking up significant portion of photo (roughly over 50% of photo width or height).</td>
    </tr>
    <tr>
      <td>Action</td>
      <td>Pet in the middle of an action (e.g., jumping).</td>
    </tr>
    <tr>
      <td>Accessory</td>
      <td>Accompanying physical or digital accessory / prop (i.e. toy, digital sticker), excluding collar and leash.</td>
    </tr>
    <tr>
      <td>Group</td>
      <td>More than 1 pet in the photo.</td>
    </tr>
    <tr>
      <td>Collage</td>
      <td>Digitally-retouched photo (i.e. with digital photo frame, combination of multiple photos).</td>
    </tr>
    <tr>
      <td>Human</td>
      <td>Human in the photo.</td>
    </tr>
    <tr>
      <td>Occlusion</td>
      <td>Specific undesirable objects blocking part of the pet (i.e. human, cage or fence). Note that not all blocking objects are</td>
    </tr>
    <tr>
      <td>Info</td>
      <td>Custom-added text or labels (i.e. pet name, description).</td>
    </tr>
    <tr>
      <td>Blur</td>
      <td>Noticeably out of focus or noisy, especially for the petâ€™s eyes and face. For Blur entries, â€œEyesâ€ column is always set to 0.</td>
    </tr>
  </tbody>
</table>

<h2 id="traincsv">train.csv</h2>

<p>idê°’, pawpularity ë¹¼ê³ ëŠ” ì „ë¶€ 0, 1 ì´ì§„ë°ì´í„°ì…ë‹ˆë‹¤.</p>

<p>pawpulairtyëŠ” 1-100ê¹Œì§€ì˜ intí˜• dataì…ë‹ˆë‹¤.</p>

<table>
  <thead>
    <tr>
      <th>id</th>
      <th>The photos unique Pet Profile ID corresponding to the photoâ€™s file name.</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Subject Focus</td>
      <td>Pet stands out against uncluttered background, not too close / far.</td>
    </tr>
    <tr>
      <td>Eyes</td>
      <td>Both eyes are facing front or near-front, with at least 1 eye / pupil decently clear.</td>
    </tr>
    <tr>
      <td>Face</td>
      <td>Decently clear face, facing front or near-front.</td>
    </tr>
    <tr>
      <td>Near</td>
      <td>Single pet taking up significant portion of photo (roughly over 50% of photo width or height).</td>
    </tr>
    <tr>
      <td>Action</td>
      <td>Pet in the middle of an action (e.g., jumping).</td>
    </tr>
    <tr>
      <td>Accessory</td>
      <td>Accompanying physical or digital accessory / prop (i.e. toy, digital sticker), excluding collar and leash.</td>
    </tr>
    <tr>
      <td>Group</td>
      <td>More than 1 pet in the photo.</td>
    </tr>
    <tr>
      <td>Collage</td>
      <td>Digitally-retouched photo (i.e. with digital photo frame, combination of multiple photos).</td>
    </tr>
    <tr>
      <td>Human</td>
      <td>Human in the photo.</td>
    </tr>
    <tr>
      <td>Occlusion</td>
      <td>Specific undesirable objects blocking part of the pet (i.e. human, cage or fence). Note that not all blocking objects are</td>
    </tr>
    <tr>
      <td>Info</td>
      <td>Custom-added text or labels (i.e. pet name, description).</td>
    </tr>
    <tr>
      <td>Blur</td>
      <td>Noticeably out of focus or noisy, especially for the petâ€™s eyes and face. For Blur entries, â€œEyesâ€ column is always set to 0.</td>
    </tr>
    <tr>
      <td>Pawpularity</td>
      <td>The Pawpularity Score is derived from each pet profileâ€™s page view statistics at the listing pages, using an algorithm</td>
    </tr>
  </tbody>
</table>

<h1 id="2-openai-clip">2. OpenAI CLIP</h1>

<p>CLIP(Contrastive Language-Image Pre-Training)ì€ ë‹¤ì–‘í•œ (ì´ë¯¸ì§€, í…ìŠ¤íŠ¸) ìŒìœ¼ë¡œ í›ˆë ¨ëœ ì‹ ê²½ë§ì…ë‹ˆë‹¤. GPT-2 ë° 3ì˜ ì œë¡œìƒ· ê¸°ëŠ¥ê³¼ ìœ ì‚¬í•˜ê²Œ ì‘ì—…ì— ëŒ€í•œ ì§ì ‘ ìµœì í™” ì—†ì´ ì£¼ì–´ì§„ ì´ë¯¸ì§€ì—ì„œ ê°€ì¥ ê´€ë ¨ì„± ë†’ì€ í…ìŠ¤íŠ¸ ìŠ¤ë‹ˆí«ì„ ì˜ˆì¸¡í•˜ë„ë¡ ìì—°ì–´ë¡œ ì§€ì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìš°ë¦¬ëŠ” CLIPì´ ì›ë³¸ ResNet50ì˜ ì„±ëŠ¥ê³¼ ì¼ì¹˜í•¨ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤. ImageNetì—ì„œ ì›ë˜ 128ë§Œ ê°œì˜ ë ˆì´ë¸”ì´ ì§€ì •ëœ ì˜ˆì œë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  â€œì œë¡œìƒ·â€ì„ ìˆ˜í–‰í•˜ì—¬ ì»´í“¨í„° ë¹„ì „ì˜ ëª‡ ê°€ì§€ ì£¼ìš” ë¬¸ì œë¥¼ ê·¹ë³µí–ˆìŠµë‹ˆë‹¤.</p>

<p>ì°¸ê³  ë§í¬ : https://github.com/openai/CLIP</p>

<h1 id="image-embedding">Image Embedding</h1>

<h3 id="ì„ë² ë”©-embeddingì´ë€">ì„ë² ë”© Embeddingì´ë€?</h3>

<p>ê³ ì°¨ì› ë²¡í„°ë¥¼ ì €ì°¨ì› ê³µê°„ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ìƒì ìœ¼ë¡œ, ì„ë² ë”©ì€ ì„ë² ë”© ê³µê°„ì—ì„œ ì˜ë¯¸ì ìœ¼ë¡œ ë¹„ìŠ·í•œ ì…ë ¥ ì‚¬í•­ë“¤ì„ ê°€ê¹ê²Œ ë°°ì¹˜í•¨ìœ¼ë¡œì¨ ì…ë ¥ì— í¬í•¨ëœ ì˜ë¯¸ ì¤‘ ì¼ë¶€ë¥¼ í¬ì°©í•©ë‹ˆë‹¤.</p>

<ul>
  <li>https://cloud.google.com/architecture/overview-extracting-and-serving-feature-embeddings-for-machine-learning?hl=ko</li>
</ul>

<h3 id="ì´ë¯¸ì§€-ì„ë² ë”©">ì´ë¯¸ì§€ ì„ë² ë”©</h3>

<p>í…ìŠ¤íŠ¸ ì‹œìŠ¤í…œê³¼ ë‹¬ë¦¬, ì´ë¯¸ì§€ ì²˜ë¦¬ ì‹œìŠ¤í…œì€ ê°œë³„ì ì¸ ì›ì‹œ í”½ì…€ ê°•ë„ë¥¼ ì§€ë‹Œ ì´ë¯¸ì§€ë¥¼ ë‚˜íƒ€ë‚´ëŠ” í’ë¶€í•˜ê³  ê³ ì°¨ì›ì ì¸ ë°ì´í„°ì„¸íŠ¸ë¡œ ì‘ë™í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ ì›ë˜ì˜ ë°€ë„ê°€ ë†’ì€ í˜•íƒœì˜ ì´ë¯¸ì§€ëŠ” ì¼ë¶€ ì‘ì—…ì— ê·¸ë¦¬ ìœ ìš©í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ì¡ì§€ í‘œì§€ ì´ë¯¸ì§€ë¥¼ ë³´ê³  ë¹„ìŠ·í•œ ì¡ì§€ë¥¼ ì°¾ê±°ë‚˜ ì°¸ì¡° ì‚¬ì§„ê³¼ ë¹„ìŠ·í•œ ì‚¬ì§„ì„ ì°¾ì•„ì•¼ í•œë‹¤ê³  ê°€ì •í•´ë³´ì„¸ìš”. ì…ë ¥ ì‚¬ì§„ì˜ ì›ì‹œ í”½ì…€(2,048 âœ• 2,048)ì„ ë‹¤ë¥¸ ì‚¬ì§„ê³¼ ë¹„êµí•˜ì—¬ ë¹„ìŠ·í•œì§€ ì—¬ë¶€ë¥¼ ì°¾ëŠ” ê²ƒì€ íš¨ìœ¨ì ì´ê±°ë‚˜ íš¨ê³¼ì ì´ì§€ ì•ŠìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì´ë¯¸ì§€ì˜ ì €ì°¨ì›ì  íŠ¹ì„± ë²¡í„°(ì„ë² ë”©)ë¥¼ ì¶”ì¶œí•˜ë©´ ì´ë¯¸ì§€ì— í¬í•¨ëœ ë‚´ìš©ì´ ë¬´ì—‡ì¸ì§€ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì¼ì •í•œ ì§€í‘œë¥¼ ì–»ê³ , ë” íš¨ê³¼ì ìœ¼ë¡œ ë¹„êµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>í•µì‹¬ì€ ëŒ€ê·œëª¨ ì´ë¯¸ì§€ ë°ì´í„° ì„¸íŠ¸(ì˜ˆ: <a href="https://arxiv.org/abs/1409.4842">ImageNet</a>)ì—ì„œ <a href="https://arxiv.org/abs/1512.03385">Inception</a>, <a href="https://ai.googleblog.com/2017/11/automl-for-large-scale-image.html">ResNet(Deep Residual Learning)</a> ë˜ëŠ” <a href="http://image-net.org/">NASNet(Network Architecture Search)</a>ê³¼ ê°™ì€ ì´ë¯¸ì§€ ë¶„ë¥˜ ëª¨ë¸ì„ í•™ìŠµì‹œí‚¤ëŠ” ê²ƒì…ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ ë§ˆì§€ë§‰ <a href="https://wikipedia.org/wiki/Softmax_function">softmax</a> ë¶„ë¥˜ ê¸°ì¤€ì´ <em>ì—†ëŠ”</em> ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ ì…ë ¥ í…ŒìŠ¤íŠ¸ì— ë”°ë¼ íŠ¹ì§• ë²¡í„°ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤. ì´ ìœ í˜•ì˜ íŠ¹ì§• ë²¡í„°ë¡œ ê²€ìƒ‰ ì‘ì—… ë˜ëŠ” ìœ ì‚¬ì„± ì¼ì¹˜ ì‘ì—…ì—ì„œ ì´ë¯¸ì§€ë¥¼ íš¨ê³¼ì ìœ¼ë¡œ í‘œí˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. íŠ¹ì§• ë²¡í„°ëŠ” ë‹¤ë¥¸ íŠ¹ì„±ê³¼ í•¨ê»˜ ML ì‘ì—…ìš© ì¶”ê°€ ì…ë ¥ íŠ¹ì„±(ë²¡í„°)ìœ¼ë¡œ ì‘ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ì˜ë¥˜ë¥¼ ì‡¼í•‘ ì¤‘ì¸ ê³ ê°ì—ê²Œ íŒ¨ì…˜ ì•„ì´í…œì„ ì¶”ì²œí•˜ëŠ” ì‹œìŠ¤í…œì—ì„œëŠ” ìƒ‰ìƒ, ì¹˜ìˆ˜, ê°€ê²©, ìœ í˜•, í•˜ìœ„ìœ í˜•ì„ ë¹„ë¡¯í•œ ê°œë³„ í•­ëª©ì„ ê¸°ìˆ í•˜ëŠ” ì†ì„±ì´ ì‚¬ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. íŒ¨ì…˜ ì•„ì´í…œ ì´ë¯¸ì§€ì—ì„œ ì¶”ì¶œëœ íŠ¹ì„±ê³¼ í•¨ê»˜ ì´ëŸ¬í•œ ëª¨ë“  íŠ¹ì„±ì„ ì¶”ì²œ ëª¨ë¸ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<h1 id="rapid-svr">RAPID SVR</h1>

<h1 id="stratifiedkfold">StratifiedKFold</h1>

<ul>
  <li>k-fold : í•™ìŠµë°ì´í„°ì…‹ê³¼ ê²€ì¦ ë°ì´í„° ì…‹ì„ ë‚˜ëˆ„ì–´ì„œ ì§„í–‰í•˜ëŠ” ê²ƒ</li>
  <li>startifiedkfold : ë¶ˆê· í˜•í•œ datasetì¼ ê²½ìš° ì‚¬ìš©í•˜ëŠ” kfold ë°©ë²•
    <ul>
      <li>kê°œì˜ foldë¥¼ ë¶„í• í•œ ì´í›„ì—ë„ ì „ì²´ í›ˆë ¨ ë°ì´í„°ì˜ class ë¹„ìœ¨ê³¼ ê° foldê°€ ê°€ì§€ê³  ìˆëŠ” class ë¹„ìœ¨ì„ ë§ì¶°ì¤ë‹ˆë‹¤.</li>
      <li><img src="../images/pages/img.png" alt="img" /></li>
    </ul>
  </li>
  <li>
    <p>ì½”ë“œ : https://guru.tistory.com/35</p>
  </li>
  <li>ì´ë¡  : https://steadiness-193.tistory.com/287</li>
</ul>

<h1 id="ì½”ë“œ-ë¶„ì„">ì½”ë“œ ë¶„ì„</h1>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'../input/petfinderdata/train-folds-1.csv'</span><span class="p">)</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'../input/petfinder-pawpularity-score/test.csv'</span><span class="p">)</span>
<span class="n">sub</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'../input/petfinder-pawpularity-score/sample_submission.csv'</span><span class="p">)</span>

<span class="n">train</span><span class="p">[</span><span class="s">'path'</span><span class="p">]</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s">'Id'</span><span class="p">].</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s">'../input/petfinder-pawpularity-score/train/'</span><span class="o">+</span><span class="n">x</span><span class="o">+</span><span class="s">'.jpg'</span><span class="p">)</span>
<span class="n">test</span><span class="p">[</span><span class="s">'path'</span><span class="p">]</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="s">'Id'</span><span class="p">].</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s">'../input/petfinder-pawpularity-score/test/'</span><span class="o">+</span><span class="n">x</span><span class="o">+</span><span class="s">'.jpg'</span><span class="p">)</span>

<span class="c1">#print(test)
# If its Public LB run, then augment Testset to chack batch size memory consumption.
</span><span class="k">if</span> <span class="n">test</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">:</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">([</span>
        <span class="n">test</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> 
    <span class="p">])</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">test</span><span class="p">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
<span class="c1"># print(test)    
</span>
<span class="k">print</span><span class="p">(</span><span class="n">train</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">test</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">sub</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">train</span><span class="p">.</span><span class="n">head</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>    

</code></pre></div></div>

<h2 id="trainê³¼-test-ë°ì´í„°ì—-path-ì»¬ëŸ¼-ì¶”ê°€">trainê³¼ test ë°ì´í„°ì— path ì»¬ëŸ¼ ì¶”ê°€.</h2>

<p>path+id.jpg ê°’ì„ ë„£ì–´ì¤Œ.</p>

<h2 id="ê¸°ì¡´-test-ë°ì´í„°ì˜-ìˆ˜ë¥¼-ëŠ˜ë ¤ì¤Œ">ê¸°ì¡´ test ë°ì´í„°ì˜ ìˆ˜ë¥¼ ëŠ˜ë ¤ì¤Œ.</h2>

<p>if ë¸”ë¡ì˜ ì—­í• ì€ ê¸°ì¡´ì˜ testë°ì´í„° ìˆ˜ë¥¼ ëŠ˜ë ¤ì£¼ëŠ” ê²ƒì…ë‹ˆë‹¤.
8 + 8 + 8 + 8 + 8ë¡œ, ê·¸ëŒ€ë¡œ testë°ì´í„°ë¥¼ ì—°ì¥ì‹œì¼œì£¼ì—ˆìŠµë‹ˆë‹¤.
(ê·¼ë° ê°™ì€ ë°ì´í„°ê°’ì´ê³  index columë§Œ ë‹¬ë¼ì§€ëŠ”ë° êµ³ì´..? ì™œ..?)</p>

<h2 id="testreset_indexdrop--true"><code class="language-plaintext highlighter-rouge">test.reset_index(drop = True)</code></h2>

<p>dropë§¤ê°œë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë©´ DataFrameì—ì„œ ì¸ë±ìŠ¤ë¥¼ ì™„ì „íˆ ì‚­ì œí• ì§€ ì—¬ë¶€ë¥¼ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ . drop = Trueí•˜ë©´ reset_indexê°€ ì¸ë±ìŠ¤ë¥¼ DataFrameì˜ ì—´ì— ë‹¤ì‹œ ì‚½ì…í•˜ëŠ” ëŒ€ì‹  ì‚­ì œí•©ë‹ˆë‹¤. ë¥¼ ì„¤ì • drop = Trueí•˜ë©´ í˜„ì¬ ì¸ë±ìŠ¤ê°€ ì™„ì „íˆ ì‚­ì œë˜ê³  ìˆ«ì ì¸ë±ìŠ¤ê°€ ì´ë¥¼ ëŒ€ì²´í•©ë‹ˆë‹¤.</p>

<ul>
  <li>https://www.sharpsightlabs.com/blog/pandas-reset-index/</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># print(train.head(50))    
</span>
<span class="n">train</span><span class="p">[</span><span class="s">'bins'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="s">'Pawpularity'</span><span class="p">]</span><span class="o">//</span><span class="mi">5</span><span class="p">).</span><span class="nb">round</span><span class="p">()</span>
<span class="c1"># print(train['Pawpularity'])
# print(train['Pawpularity'].value_counts())
# print(train.head(50))    
</span><span class="k">print</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="s">'bins'</span><span class="p">].</span><span class="n">value_counts</span><span class="p">())</span>



<span class="n">train</span><span class="p">[</span><span class="s">'fold0'</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">skf</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">test_index</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">skf</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">train</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="n">train</span><span class="p">[</span><span class="s">'bins'</span><span class="p">])):</span>
    <span class="n">train</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

<span class="k">print</span><span class="p">(</span><span class="s">'test_index'</span><span class="p">,</span> <span class="n">test_index</span><span class="p">)</span>    
<span class="k">print</span><span class="p">(</span><span class="s">'test_index len'</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_index</span><span class="p">))</span>
<span class="c1"># print(train.head(50))    
</span>    
<span class="n">train</span><span class="p">[</span><span class="s">'fold0'</span><span class="p">]</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s">'fold0'</span><span class="p">].</span><span class="n">astype</span><span class="p">(</span><span class="s">'int'</span><span class="p">)</span>
<span class="n">gc</span><span class="p">.</span><span class="n">collect</span><span class="p">()</span>

<span class="n">train</span><span class="p">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'fold0'</span><span class="p">])[</span><span class="s">'Pawpularity'</span><span class="p">].</span><span class="n">agg</span><span class="p">([</span><span class="s">'mean'</span><span class="p">,</span><span class="s">'std'</span><span class="p">,</span><span class="s">'count'</span><span class="p">])</span>
</code></pre></div></div>

<h2 id="bins-ì—´">bins ì—´</h2>

<p>pawpularityì˜ ì •ë‹µë¼ë²¨ì„ 20ê°œë¡œ ë§ì¶°ì£¼ê¸° ìœ„í•¨ (1-100 ê¹Œì§€ì˜ ì •ë‹µë¼ë²¨ ì¡´ì¬, //5 í•˜ë©´ 20ê°œë¡œ ë‚˜ë‰˜ì–´ì§)</p>

<h2 id="stratifiedkfold-1">StratifiedKFold</h2>

<ul>
  <li>
    <p>ë¶ˆê· í˜•í•œ datasetì¼ ê²½ìš° ì‚¬ìš©í•˜ëŠ” kfold ë°©ë²•</p>
  </li>
  <li>
    <p>kê°œì˜ foldë¥¼ ë¶„í• í•œ ì´í›„ì—ë„ ì „ì²´ í›ˆë ¨ ë°ì´í„°ì˜ class ë¹„ìœ¨ê³¼ ê° foldê°€ ê°€ì§€ê³  ìˆëŠ” class ë¹„ìœ¨ì„ ë§ì¶°ì¤ë‹ˆë‹¤.</p>
  </li>
</ul>

<h2 id="enumerateë¬¸">enumerateë¬¸</h2>

<p>ë‚˜ë„ ëª¨ë¥´ê² ìŒ.</p>

<h2 id="astype">astype</h2>

<p>train[â€˜fold0â€™] ì»¬ëŸ¼ì„ intí˜•ìœ¼ë¡œ ë³€í™˜</p>

<h2 id="groupby">groupby</h2>

<p><code class="language-plaintext highlighter-rouge">train.groupby(['fold0'])['Pawpularity'].agg(['mean','std','count'])</code></p>

<p>foldë§ˆë‹¤ pawpularityì˜ mean(í‰ê· ), std(í‘œì¤€í¸ì°¨), count(ê°œìˆ˜)ê°’ì„ ë‚˜íƒ€ë‚´ì¤ë‹ˆë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">modelpath</span> <span class="o">=</span> <span class="p">{</span> <span class="n">m</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="s">'../input/pytorch-pretrained-0/*.pt'</span><span class="p">)</span><span class="o">+</span><span class="n">glob</span><span class="p">(</span><span class="s">'../input/pytorch-pretrained-1/*.pt'</span><span class="p">)</span><span class="o">+</span><span class="n">glob</span><span class="p">(</span><span class="s">'../input/pytorch-pretrained-2/*.pt'</span><span class="p">)</span><span class="o">+</span><span class="n">glob</span><span class="p">(</span><span class="s">'../input/pytorch-pretrained-3/*.pt'</span><span class="p">)}</span>
<span class="n">modelpath</span>

</code></pre></div></div>

<h2 id="ì˜ˆì‹œ">ì˜ˆì‹œ</h2>

<ul>
  <li>str = ../input/pytorch-pretrained-0/resnetv2_101x1_bitm.pt ì¼ë•Œ,</li>
</ul>

<p>str.split(â€˜/â€™) ì˜ ê²°ê³¼</p>

<blockquote>
  <p>../input/pytorch-pretrained-0/resnetv2_101x1_bitm.pt</p>
</blockquote>

<p>str.split(â€˜/â€™)[-1] ì˜ ê²°ê³¼</p>

<blockquote>
  <p>[â€™..â€™, â€˜inputâ€™, â€˜pytorch-pretrained-0â€™, â€˜resnetv2_101x1_bitm.ptâ€™]</p>
</blockquote>

<p>str.split(â€˜/â€™)[-1].split(â€˜.â€™)ì˜ ê²°ê³¼</p>

<blockquote>
  <p>[â€˜resnetv2_101x1_bitmâ€™, â€˜ptâ€™]</p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># EMB TESTê°€ ë­˜ê¹Œ
</span><span class="n">EMB_TEST</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">arch</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
    <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">timm</span><span class="p">.</span><span class="n">create_model</span><span class="p">(</span><span class="n">arch</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="bp">False</span><span class="p">).</span><span class="n">to</span><span class="p">(</span><span class="s">'cuda'</span><span class="p">)</span>
    <span class="n">model</span><span class="p">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">modelpath</span><span class="p">[</span><span class="n">arch</span><span class="p">]))</span>
    <span class="n">model</span><span class="p">.</span><span class="nb">eval</span><span class="p">()</span>

    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">PawpularDataset</span><span class="p">(</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">test</span><span class="p">.</span><span class="n">Id</span><span class="p">.</span><span class="n">values</span><span class="p">,</span>
        <span class="n">base_path</span><span class="o">=</span><span class="s">'../input/petfinder-pawpularity-score/test/'</span><span class="p">,</span>
        <span class="n">modelcfg</span> <span class="o">=</span> <span class="n">resolve_data_config</span><span class="p">({},</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">),</span>
        <span class="n">aug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">BS</span> <span class="o">=</span> <span class="mi">10</span> <span class="k">if</span> <span class="n">arch</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'tf_efficientnet_l2_ns'</span><span class="p">]</span> <span class="k">else</span> <span class="mi">16</span>
    <span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BS</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    
    <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="p">(</span><span class="n">img</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="s">'cuda'</span><span class="p">)).</span><span class="n">cpu</span><span class="p">().</span><span class="n">numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">train_dataloader</span><span class="p">]</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">EMB_TEST</span><span class="p">[</span><span class="n">arch</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>
    
    <span class="k">print</span><span class="p">(</span> <span class="n">arch</span><span class="p">,</span> <span class="s">', Done in:'</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">starttime</span><span class="p">),</span> <span class="s">'s'</span> <span class="p">)</span>
    
    <span class="k">del</span> <span class="n">model</span><span class="p">,</span> <span class="n">res</span>
    <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">empty_cache</span><span class="p">()</span> <span class="c1"># PyTorch thing to clean RAM
</span>    <span class="n">gc</span><span class="p">.</span><span class="n">collect</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="p">)</span>    
<span class="nb">len</span><span class="p">(</span><span class="n">EMB_TEST</span><span class="p">),</span> <span class="n">EMB_TEST</span><span class="p">.</span><span class="n">keys</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="timmcreate_modelarch-pretrainedfalsetocuda">timm.create_model(arch, pretrained=False).to(â€˜cudaâ€™)</h2>

<ul>
  <li>
    <p>timm.create_model</p>

    <blockquote>
      <p><code class="language-plaintext highlighter-rouge">timm</code> is a deep-learning library created by <a href="https://twitter.com/wightmanr">Ross Wightman</a> and is a collection of SOTA computer vision models, layers, utilities, optimizers, schedulers, data-loaders, augmentations and also training/validating scripts with ability to reproduce ImageNet training results.</p>
    </blockquote>

    <p>https://fastai.github.io/timmdocs/</p>

    <p>pretrained=falseì¸ ìƒíƒœë¡œ namesì˜ ê°ì²´ë“¤ì„ ë¶ˆëŸ¬ì™€ ëª¨ë¸ì„ ìƒì„±í•´ì¤ë‹ˆë‹¤. gpuë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ <code class="language-plaintext highlighter-rouge">.to('cuda')</code>ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ ì£¼ì—ˆìŠµë‹ˆë‹¤.</p>

    <p>ê·¸ë°–ì˜ gpuë¥¼ ì‚¬ìš©í•  ìˆ˜ìˆëŠ” ëª…ë ¹ì–´ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

    <ul>
      <li>
        <p>x = torch.tensor([1., 2.], device=â€cudaâ€)</p>
      </li>
      <li>
        <p>x = torch.tensor([1., 2.]).cuda()</p>
      </li>
      <li>
        <p>https://y-rok.github.io/pytorch/2020/10/03/pytorch-gpu.html</p>
      </li>
    </ul>
  </li>
</ul>

<h2 id="load_state_dicttorchloadmodelpatharch">load_state_dict(torch.load(modelpath[arch]))</h2>

<ul>
  <li>load_state_dictëŠ” ê°€ì¤‘ì¹˜ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë©”ì†Œë“œì…ë‹ˆë‹¤.</li>
  <li>
    <p>ìƒˆë¡œìš´ ëª¨ë¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•œ í›„ì— ê°€ì¤‘ì¹˜ë¥¼ ë¶ˆëŸ¬ì˜¬ ê²½ìš°, pretrained =Falseë¥¼ ì£¼ê³ , load_state_dictë©”ì†Œë“œë¥¼ ì´ìš©í•´ ê°€ì¤‘ì¹˜ ê°’ì„ë¶ˆëŸ¬ì˜¤ê²Œ ë©ë‹ˆë‹¤.</p>
  </li>
  <li>https://tutorials.pytorch.kr/beginner/basics/saveloadrun_tutorial.html</li>
</ul>

<h2 id="modeleval">model.eval()</h2>

<ul>
  <li>
    <p>ì¶”ë¡ (inference)ì„ í•˜ê¸° ì „ì— <code class="language-plaintext highlighter-rouge">model.eval()</code> ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•˜ì—¬ ë“œë¡­ì•„ì›ƒ(dropout)ê³¼ ë°°ì¹˜ ì •ê·œí™”(batch normalization)ë¥¼ í‰ê°€ ëª¨ë“œ(evaluation mode)ë¡œ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì¼ê´€ì„± ì—†ëŠ” ì¶”ë¡  ê²°ê³¼ê°€ ìƒì„±ë©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">.eval()</code> í•¨ìˆ˜ëŠ” evaluation ê³¼ì •ì—ì„œ ì‚¬ìš©í•˜ì§€ ì•Šì•„ì•¼ í•˜ëŠ” layerë“¤ì„ ì•Œì•„ì„œ off ì‹œí‚¤ë„ë¡ í•˜ëŠ” í•¨ìˆ˜ì´ë©°</p>

    <p>evaluation/validation ê³¼ì •ì—ì„  ë³´í†µ <code class="language-plaintext highlighter-rouge">model.eval()</code>ê³¼ <code class="language-plaintext highlighter-rouge">torch.no_grad()</code>ë¥¼ í•¨ê»˜ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>
  </li>
  <li>ì‚¬ìš© ë°©ë²• ê´€ë ¨ url : https://tutorials.pytorch.kr/beginner/basics/saveloadrun_tutorial.html</li>
  <li>eval ì´ ë¬´ì—‡ì¸ì§€ : https://stackoverflow.com/questions/60018578/what-does-model-eval-do-in-pytorch/60018731#60018731</li>
  <li>eval ì´ ë¬´ì—‡ì¸ì§€ : https://bluehorn07.github.io/2021/02/27/model-eval-and-train.html</li>
</ul>

<h2 id="dataloadertrain_dataset-batch_sizebs-num_workers-2-shufflefalse">DataLoader(train_dataset, batch_size=BS, num_workers= 2, shuffle=False)</h2>

<ul>
  <li>
    <p>dataloaderëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë‹¨ì¼ í”„ë¡œì„¸ìŠ¤ ë°ì´í„° ë¡œë“œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. num_workers ì— ì–‘ì˜ ì •ìˆ˜ë¥¼ ì„¤ì •í•˜ê²Œë˜ë©´, ì§€ì •ëœ ìˆ˜ì˜ ë¡œë” ì‘ì—…ì í”„ë¡œì„¸ìŠ¤ë¡œ ë©€í‹° í”„ë¡œì„¸ìŠ¤ ë°ì´í„° ë¡œë“œê°€ ì¼œì§‘ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>https://tutorials.pytorch.kr/beginner/basics/data_tutorial.html</p>
  </li>
</ul>

<h2 id="with-torchno_grad">with torch.no_grad():</h2>

<ul>
  <li>
    <p>ìì›ì„ íšë“í•˜ê³  ì‚¬ìš© í›„ ë°˜ë‚©í•´ì•¼ í•˜ëŠ” ê²½ìš°ì— ì£¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>https://m.blog.naver.com/PostView.naver?isHttpsRedirect=true&amp;blogId=wideeyed&amp;logNo=221653260516</p>
  </li>
  <li>
    <p><img src="../images/pages/image-20220208130816814.png" alt="image-20220208130816814" /></p>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PawpularDataset_HFLIP</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">base_path</span><span class="o">=</span><span class="s">'../input/petfinder-pawpularity-score/train/'</span><span class="p">,</span> <span class="n">modelcfg</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">doflip</span><span class="o">=</span><span class="bp">False</span> <span class="p">):</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">base_path</span> <span class="o">=</span> <span class="n">base_path</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">modelcfg</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">doflip</span><span class="o">=</span><span class="n">doflip</span>
        
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">images</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">base_path</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">images</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">+</span> <span class="s">'.jpg'</span><span class="p">).</span><span class="n">convert</span><span class="p">(</span><span class="s">'RGB'</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">doflip</span><span class="o">==</span><span class="bp">True</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">PIL</span><span class="p">.</span><span class="n">Image</span><span class="p">.</span><span class="n">FLIP_LEFT_RIGHT</span><span class="p">)</span>
            <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">size</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">crop</span><span class="p">((</span><span class="mf">0.0</span><span class="o">*</span><span class="n">width</span><span class="p">,</span> <span class="mf">0.02</span><span class="o">*</span><span class="n">height</span><span class="p">,</span> <span class="mf">0.98</span><span class="o">*</span><span class="n">width</span><span class="p">,</span> <span class="mf">0.98</span> <span class="o">*</span> <span class="n">height</span><span class="p">))</span>  
        
        <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">img</span>


<span class="k">for</span> <span class="n">arch</span> <span class="ow">in</span> <span class="n">names_hflip_crop</span><span class="p">:</span>
    <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">archname</span> <span class="o">=</span> <span class="n">arch</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'_hflip_'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">arch</span> <span class="o">==</span> <span class="s">'tf_efficientnet_l2_ns_512'</span><span class="p">:</span>
        <span class="n">archname</span> <span class="o">=</span> <span class="s">'tf_efficientnet_l2_ns'</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">timm</span><span class="p">.</span><span class="n">create_model</span><span class="p">(</span><span class="n">archname</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="bp">False</span><span class="p">).</span><span class="n">to</span><span class="p">(</span><span class="s">'cuda'</span><span class="p">)</span>
    <span class="n">model</span><span class="p">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">modelpath</span><span class="p">[</span><span class="n">archname</span><span class="p">]))</span>
    <span class="n">model</span><span class="p">.</span><span class="nb">eval</span><span class="p">()</span>
    
     <span class="c1"># Get model default transforms
</span>    <span class="n">transf</span> <span class="o">=</span> <span class="n">resolve_data_config</span><span class="p">({},</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
    <span class="n">sz</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">arch</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'_'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">transf</span><span class="p">[</span><span class="s">'input_size'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">sz</span><span class="p">)</span>
    <span class="n">transf</span><span class="p">[</span><span class="s">'crop_pct'</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>        
    <span class="n">transf</span> <span class="o">=</span> <span class="n">create_transform</span><span class="p">(</span><span class="o">**</span><span class="n">transf</span><span class="p">)</span>

    <span class="n">doflip</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">arch</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'_'</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">'hflip'</span> <span class="k">else</span> <span class="bp">False</span>
    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">PawpularDataset_HFLIP</span><span class="p">(</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">test</span><span class="p">.</span><span class="n">Id</span><span class="p">.</span><span class="n">values</span><span class="p">,</span>
        <span class="n">base_path</span><span class="o">=</span><span class="s">'../input/petfinder-pawpularity-score/test/'</span><span class="p">,</span>
        <span class="n">modelcfg</span> <span class="o">=</span> <span class="n">transf</span><span class="p">,</span>
        <span class="n">doflip</span> <span class="o">=</span> <span class="n">doflip</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">BS</span> <span class="o">=</span> <span class="mi">10</span> <span class="k">if</span> <span class="n">archname</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'tf_efficientnet_l2_ns'</span><span class="p">]</span> <span class="k">else</span> <span class="mi">16</span>
    <span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BS</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="p">(</span><span class="n">img</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="s">'cuda'</span><span class="p">)).</span><span class="n">cpu</span><span class="p">().</span><span class="n">numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">train_dataloader</span><span class="p">]</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">EMB_TEST</span><span class="p">[</span><span class="n">arch</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>

    <span class="k">print</span><span class="p">(</span> <span class="n">arch</span><span class="p">,</span> <span class="s">'imge size:'</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="s">'Hflip:'</span><span class="p">,</span> <span class="n">doflip</span><span class="p">,</span> <span class="s">',Done in:'</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">starttime</span><span class="p">),</span> <span class="s">'s'</span> <span class="p">)</span>
    
    <span class="k">del</span> <span class="n">model</span><span class="p">,</span> <span class="n">res</span>
    <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">empty_cache</span><span class="p">()</span> <span class="c1"># PyTorch thing to clean RAM
</span>    <span class="n">gc</span><span class="p">.</span><span class="n">collect</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="p">)</span>    
<span class="nb">len</span><span class="p">(</span><span class="n">EMB_TEST</span><span class="p">),</span> <span class="n">EMB_TEST</span><span class="p">.</span><span class="n">keys</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="imgtransposepilimageflip_left_right">img.transpose(PIL.Image.FLIP_LEFT_RIGHT)</h2>

<p>ì´ë¯¸ì§€ë¥¼ ê°€ë¡œë°©í–¥ìœ¼ë¡œ ë’¤ì§‘ê¸°</p>

<h2 id="archsplit">arch.split()</h2>

<p><img src="../images/pages/image-20220208140254326.png" alt="image-20220208140254326" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">archname</span> <span class="o">=</span> <span class="n">arch</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'_hflip_'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">arch</span> <span class="o">==</span> <span class="s">'tf_efficientnet_l2_ns_512'</span><span class="p">:</span>
        <span class="n">archname</span> <span class="o">=</span> <span class="s">'tf_efficientnet_l2_ns'</span>
</code></pre></div></div>

<p>archnameì— ëª¨ë¸ì´ë¦„ë§Œ ë“¤ì–´ê°€ë„ë¡ ì²˜ë¦¬</p>

<h2 id="sz--intarchsplit_-1">sz = int(arch.split(â€˜_â€™)[-1])</h2>

<h1 id="ìƒˆë¡œ-ì•Œê²Œëœ-í•¨ìˆ˜">ìƒˆë¡œ ì•Œê²Œëœ í•¨ìˆ˜</h1>

<ul>
  <li>
    <p>round()</p>

    <p>ë°˜ì˜¬ë¦¼ í•¨ìˆ˜ì…ë‹ˆë‹¤.</p>

    <p>import mathë¥¼ í•˜ë©´ ì‚¬ìš©í•  ìˆ˜ ìˆìœ¼ë©°, ìˆ«ìë°ì´í„°.round()í˜•ì‹ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>pandas.astype(â€˜íƒ€ì…â€™)</p>

    <p>ì»¬ëŸ¼ì˜ ë°ì´í„° íƒ€ì…ì„ ë³€ê²½</p>
  </li>
</ul>

<h1 id="ê¶ê¸ˆí•œ-ì ">ê¶ê¸ˆí•œ ì </h1>

<ul>
  <li>
    <p>Load Train and Test</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># If its Public LB run, then augment Testset to chack batch size memory consumption.
</span><span class="k">if</span> <span class="n">test</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">:</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">([</span>
        <span class="n">test</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> 
    <span class="p">])</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">test</span><span class="p">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div>    </div>

    <p>ê¸°ë³¸ ì œê³µ ë°ì´í„°ì—ì„œ test ë°ì´í„° ìˆ˜ê°€ 8ê°œê°€ ìˆìŠµë‹ˆë‹¤. ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´ test ë°ì´í„° ìˆ˜ê°€ 10ê°œë³´ë‹¤ ì‘ê¸° ë•Œë¬¸ì— test í•œì„¸íŠ¸ë¥¼ 5ë²ˆ ì—°ì¥ ì‹œì¼œ ì´ 40ê°œì˜ testì…‹ìœ¼ë¡œ ëŠ˜ë ¤ì£¼ì—ˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì´ë ‡ê²Œ í•´ë´¤ì ê°™ì€ testë°ì´í„°ì´ê¸° ë•Œë¬¸ì— ê°ê° ê°™ì€ ê²°ê³¼ê°€ ë‚˜ì˜¬ ê²ƒ ê°™ì€ë° êµ³ì´ ì™œ ì´ë ‡ê²Œ í•´ì£¼ì—ˆëŠ”ì§€ ëª¨ë¥´ê² ìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>StratifiedKFold</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train</span><span class="p">[</span><span class="s">'bins'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="s">'Pawpularity'</span><span class="p">]</span><span class="o">//</span><span class="mi">5</span><span class="p">).</span><span class="nb">round</span><span class="p">()</span>
  
<span class="n">train</span><span class="p">[</span><span class="s">'fold0'</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">skf</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">test_index</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">skf</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">train</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="n">train</span><span class="p">[</span><span class="s">'bins'</span><span class="p">])):</span>
    <span class="n">train</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
  
<span class="n">train</span><span class="p">[</span><span class="s">'fold0'</span><span class="p">]</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s">'fold0'</span><span class="p">].</span><span class="n">astype</span><span class="p">(</span><span class="s">'int'</span><span class="p">)</span>
<span class="n">gc</span><span class="p">.</span><span class="n">collect</span><span class="p">()</span>
  
<span class="n">train</span><span class="p">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'fold0'</span><span class="p">])[</span><span class="s">'Pawpularity'</span><span class="p">].</span><span class="n">agg</span><span class="p">([</span><span class="s">'mean'</span><span class="p">,</span><span class="s">'std'</span><span class="p">,</span><span class="s">'count'</span><span class="p">])</span>
</code></pre></div>    </div>

    <p>enumerateë¶€ë¶„ ì˜ ëª°ê² ë‹¤. ì–´ë–¤ íš¨ê³¼ì¸ì§€ ã…_ã…</p>
  </li>
</ul>

:ET